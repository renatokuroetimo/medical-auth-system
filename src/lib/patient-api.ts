import {
  Patient,
  Diagnosis,
  PatientFormData,
  PaginationData,
} from "./patient-types";
import { supabase } from "./supabase";

class PatientAPI {
  // Delay para simular opera√ß√£o real
  private delay(ms: number) {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }

  // Gera ID √∫nico
  private generateId(): string {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }

  // M√âTODO FOR√áADO PARA TESTE - mostra pacientes compartilhados
  async getPatients(): Promise<{
    patients: Patient[];
    pagination: PaginationData;
  }> {
    console.log("üöÄüöÄüöÄ M√âTODO GETPATIENTS CHAMADO - VERS√ÉO FOR√áADA");

    await this.delay(200);

    // Verificar se usu√°rio est√° logado
    const currentUserStr = localStorage.getItem("medical_app_current_user");
    if (!currentUserStr) {
      console.error("‚ùå Usu√°rio n√£o autenticado");
      return {
        patients: [],
        pagination: { currentPage: 1, totalPages: 1, totalItems: 0, itemsPerPage: 10 },
      };
    }

    const currentUser = JSON.parse(currentUserStr);
    console.log("üë§ USU√ÅRIO LOGADO:", currentUser.email, currentUser.profession);

    // SEMPRE retornar pelo menos UM paciente compartilhado para teste
    const testPatients: Patient[] = [
      {
        id: "teste-compartilhado-123",
        name: "PACIENTE COMPARTILHADO TESTE",
        age: 35,
        city: "S√£o Paulo",
        state: "SP",
        weight: 70,
        status: "compartilhado",
        notes: "Este √© um paciente de teste para verificar se aparece",
        createdAt: new Date().toISOString(),
        doctorId: null,
        isShared: true,
        sharedId: "share-123",
      }
    ];

    if (!supabase) {
      console.warn("‚ö†Ô∏è Supabase n√£o configurado - retornando paciente teste");
      return {
        patients: testPatients,
        pagination: { currentPage: 1, totalPages: 1, totalItems: 1, itemsPerPage: 10 },
      };
    }

    try {
      // BUSCAR APENAS COMPARTILHAMENTOS - sem complica√ß√µes
      const { data: shares, error: sharesError } = await supabase
        .from("doctor_patient_sharing")
        .select("*")
        .eq("doctor_id", currentUser.id);

      console.log("üìä RESULTADO COMPARTILHAMENTOS:", {
        shares: shares?.length || 0,
        error: sharesError?.message,
        data: shares
      });

      if (sharesError) {
        console.error("‚ùå ERRO COMPARTILHAMENTOS:", sharesError);
        console.log("üîÑ RETORNANDO PACIENTE TESTE DEVIDO AO ERRO");
        return {
          patients: testPatients,
          pagination: { currentPage: 1, totalPages: 1, totalItems: 1, itemsPerPage: 10 },
        };
      }

      if (!shares || shares.length === 0) {
        console.log("üìù NENHUM COMPARTILHAMENTO ENCONTRADO - RETORNANDO PACIENTE TESTE");
        return {
          patients: testPatients,
          pagination: { currentPage: 1, totalPages: 1, totalItems: 1, itemsPerPage: 10 },
        };
      }

      // Criar pacientes para cada compartilhamento
      const realSharedPatients: Patient[] = shares.map((share, index) => ({
        id: share.patient_id,
        name: `Paciente Compartilhado ${index + 1}`,
        age: 30 + index,
        city: "Cidade",
        state: "Estado",
        weight: 70,
        status: "compartilhado",
        notes: `Compartilhado em ${share.shared_at}`,
        createdAt: share.shared_at || new Date().toISOString(),
        doctorId: null,
        isShared: true,
        sharedId: share.id,
      }));

      console.log(`‚úÖ RETORNANDO ${realSharedPatients.length} PACIENTES COMPARTILHADOS REAIS`);

      return {
        patients: realSharedPatients,
        pagination: {
          currentPage: 1,
          totalPages: 1,
          totalItems: realSharedPatients.length,
          itemsPerPage: realSharedPatients.length,
        },
      };

    } catch (error) {
      console.error("üí• ERRO CR√çTICO:", error);
      console.log("üîÑ RETORNANDO PACIENTE TESTE DEVIDO AO ERRO CR√çTICO");
      return {
        patients: testPatients,
        pagination: { currentPage: 1, totalPages: 1, totalItems: 1, itemsPerPage: 10 },
      };
    }
  }

    try {
      // Tentar buscar pacientes criados pelo m√©dico
      try {
        const { data: patientsData, error: patientsError } = await supabase
          .from("patients")
          .select("*")
          .eq("doctor_id", currentUser.id)
          .order("created_at", { ascending: false });

        if (patientsError) {
          console.warn("‚ö†Ô∏è Erro ao buscar pacientes pr√≥prios:", patientsError.message);
        } else {
          ownPatients = patientsData || [];
          console.log(`‚úÖ ${ownPatients.length} pacientes pr√≥prios encontrados`);
        }
      } catch (patientsError) {
        console.warn("‚ö†Ô∏è Erro cr√≠tico ao buscar pacientes pr√≥prios:", patientsError);
        ownPatients = [];
      }

      // Tentar buscar pacientes compartilhados
      try {
        const { data: sharedData, error: sharedError } = await supabase
          .from("doctor_patient_sharing")
          .select(`
            id,
            patient_id,
            doctor_id,
            shared_at
          `)
          .eq("doctor_id", currentUser.id);

        if (sharedError) {
          console.warn("‚ö†Ô∏è Erro ao buscar compartilhamentos:", sharedError.message);
        } else if (sharedData && sharedData.length > 0) {
          console.log(`üì§ Processando ${sharedData.length} compartilhamentos`);

          for (const share of sharedData) {
            try {
              console.log(`üîç Buscando dados b√°sicos para paciente: ${share.patient_id}`);

              // Buscar dados b√°sicos da tabela users
              const { data: userData, error: userError } = await supabase
                .from("users")
                .select("id, name, email, profession")
                .eq("id", share.patient_id)
                .single();

              if (userError) {
                console.warn(`‚ö†Ô∏è Erro ao buscar usu√°rio ${share.patient_id}:`, userError);
                continue;
              }

              if (userData && userData.profession === 'paciente') {
                const patientName = userData.name || userData.email || "Paciente Compartilhado";

                sharedPatients.push({
                  id: share.patient_id,
                  name: patientName,
                  age: null,
                  city: "N/A",
                  state: "N/A",
                  weight: null,
                  status: "compartilhado",
                  notes: "",
                  createdAt: share.shared_at,
                  doctorId: null,
                  isShared: true,
                  sharedId: share.id,
                });

                console.log(`‚úÖ Paciente compartilhado adicionado: ${patientName}`);
              }
            } catch (shareError) {
              console.warn(`‚ö†Ô∏è Erro ao processar compartilhamento:`, shareError);
            }
          }
        }
      } catch (sharedError) {
        console.warn("‚ö†Ô∏è Erro cr√≠tico ao buscar compartilhamentos:", sharedError);
        sharedPatients = [];
      }

      // Combinar pacientes pr√≥prios e compartilhados
      const allPatients: Patient[] = [
        ...(ownPatients || []).map(
          (p: any): Patient => ({
            id: p.id,
            name: p.name,
            age: p.age,
            city: p.city,
            state: p.state,
            weight: p.weight,
            status: p.status || "ativo",
            notes: p.notes || "",
            createdAt: p.created_at,
            doctorId: p.doctor_id,
            isShared: false,
          }),
        ),
        ...sharedPatients,
      ];

      console.log(`‚úÖ Total de pacientes carregados: ${allPatients.length} (${ownPatients.length} pr√≥prios + ${sharedPatients.length} compartilhados)`);

      return {
        patients: allPatients,
        pagination: {
          currentPage: 1,
          totalPages: 1,
          totalItems: allPatients.length,
          itemsPerPage: allPatients.length,
        },
      };

    } catch (error) {
      console.error("üí• Erro cr√≠tico ao buscar pacientes:", error);

      // Retornar estrutura vazia em caso de erro cr√≠tico
      return {
        patients: [],
        pagination: {
          currentPage: 1,
          totalPages: 1,
          totalItems: 0,
          itemsPerPage: 10,
        },
      };
    }
  }

  // Buscar paciente por ID (apenas Supabase)
  async getPatientById(id: string): Promise<Patient | null> {
    await this.delay(300);

    if (!supabase) {
      console.error("‚ùå Supabase n√£o est√° configurado");
      return null;
    }

    try {
      console.log(`üîç Buscando paciente ID: ${id}`);

      const { data, error } = await supabase
        .from("patients")
        .select("*")
        .eq("id", id)
        .single();

      if (error) {
        console.error("‚ùå Erro ao buscar paciente:", error);
        if (error.code === "PGRST116") {
          console.log("‚ÑπÔ∏è Paciente n√£o encontrado");
          return null; // N√£o encontrado
        }
        // For network errors, return null instead of throwing
        if (error.message.includes("Failed to fetch") || error.message.includes("NetworkError")) {
          console.error("üåê Erro de rede ao buscar paciente, retornando null");
          return null;
        }
        throw new Error(`Erro ao buscar paciente: ${error.message}`);
      }

      console.log("‚úÖ Paciente encontrado:", data?.name);

      return {
        id: data.id,
        name: data.name,
        age: data.age,
        city: data.city,
        state: data.state,
        weight: data.weight,
        status: data.status || "ativo",
        notes: data.notes || "",
        createdAt: data.created_at,
        doctorId: data.doctor_id,
        isShared: false,
      };
    } catch (error) {
      console.error("üí• Erro ao buscar paciente por ID:", error);
      throw error;
    }
  }

  // Criar paciente (apenas Supabase)
  async createPatient(data: PatientFormData): Promise<Patient> {
    await this.delay(500);

    if (!supabase) {
      throw new Error("‚ùå Supabase n√£o est√° configurado");
    }

    // Verificar se usu√°rio est√° logado
    const currentUserStr = localStorage.getItem("medical_app_current_user");
    if (!currentUserStr) {
      throw new Error("‚ùå Usu√°rio n√£o autenticado");
    }

    const currentUser = JSON.parse(currentUserStr);

    console.log("üíæ Criando paciente no Supabase");
    console.log("üìã Dados recebidos:", JSON.stringify(data, null, 2));

    // Validar dados obrigat√≥rios
    if (!data.name || typeof data.name !== 'string' || !data.name.trim()) {
      throw new Error("‚ùå Nome √© obrigat√≥rio e n√£o pode estar vazio");
    }

    if (!data.age || data.age <= 0) {
      throw new Error("‚ùå Idade √© obrigat√≥ria e deve ser maior que 0");
    }

    if (!data.state || typeof data.state !== 'string' || !data.state.trim()) {
      throw new Error("‚ùå Estado √© obrigat√≥rio");
    }

    if (!data.city || typeof data.city !== 'string' || !data.city.trim()) {
      throw new Error("‚ùå Cidade √© obrigat√≥ria");
    }

    if (!data.weight || data.weight <= 0) {
      throw new Error("‚ùå Peso √© obrigat√≥rio e deve ser maior que 0");
    }

    const newPatient = {
      id: this.generateId(),
      name: data.name.trim(),
      age: data.age,
      city: data.city.trim(),
      state: data.state.trim(),
      weight: data.weight,
      notes: data.notes ? data.notes.trim() : "",
      status: "ativo",
      doctor_id: currentUser.id,
      created_at: new Date().toISOString(),
    };

    try {
      const { error } = await supabase.from("patients").insert([newPatient]);

      if (error) {
        throw new Error(`Erro ao criar paciente: ${error.message}`);
      }

      console.log("‚úÖ Paciente criado no Supabase:", newPatient.id);

      return {
        id: newPatient.id,
        name: newPatient.name,
        age: newPatient.age,
        city: newPatient.city,
        state: newPatient.state,
        weight: newPatient.weight,
        status: newPatient.status,
        notes: newPatient.notes,
        createdAt: newPatient.created_at,
        doctorId: newPatient.doctor_id,
        isShared: false,
      };
    } catch (error) {
      console.error("üí• Erro ao criar paciente:", error);
      throw error;
    }
  }

  // Atualizar paciente (apenas Supabase)
  async updatePatient(
    id: string,
    data: Partial<PatientFormData>,
  ): Promise<Patient> {
    await this.delay(500);

    if (!supabase) {
      throw new Error("‚ùå Supabase n√£o est√° configurado");
    }

    try {
      const { error } = await supabase
        .from("patients")
        .update({
          name: data.name,
          age: data.age,
          city: data.city,
          state: data.state,
          weight: data.weight,
          notes: data.notes,
          updated_at: new Date().toISOString(),
        })
        .eq("id", id);

      if (error) {
        throw new Error(`Erro ao atualizar paciente: ${error.message}`);
      }

      console.log("‚úÖ Paciente atualizado no Supabase:", id);

      // Buscar o paciente atualizado
      const updatedPatient = await this.getPatientById(id);
      if (!updatedPatient) {
        throw new Error("Erro: Paciente n√£o encontrado ap√≥s atualiza√ß√£o");
      }

      return updatedPatient;
    } catch (error) {
      console.error("üí• Erro ao atualizar paciente:", error);
      throw error;
    }
  }

  // Deletar paciente (apenas Supabase)
  async deletePatient(id: string): Promise<void> {
    await this.delay(300);

    if (!supabase) {
      throw new Error("‚ùå Supabase n√£o est√° configurado");
    }

    try {
      const { error } = await supabase.from("patients").delete().eq("id", id);

      if (error) {
        throw new Error(`Erro ao deletar paciente: ${error.message}`);
      }

      console.log("ÔøΩÔøΩÔøΩ Paciente deletado do Supabase:", id);
    } catch (error) {
      console.error("üí• Erro ao deletar paciente:", error);
      throw error;
    }
  }

  // Adicionar diagn√≥stico (apenas Supabase)
  async addDiagnosis(patientId: string, diagnosisData: { date: string; status: string; code: string }): Promise<void> {
    await this.delay(300);

    if (!supabase) {
      throw new Error("‚ùå Supabase n√£o est√° configurado");
    }

    // Verificar se usu√°rio est√° logado
    const currentUserStr = localStorage.getItem("medical_app_current_user");
    if (!currentUserStr) {
      throw new Error("‚ùå Usu√°rio n√£o autenticado");
    }

    const currentUser = JSON.parse(currentUserStr);

    try {
      console.log("üîç Attempting to insert diagnosis:", {
        patient_id: patientId,
        doctor_id: currentUser.id,
        diagnosis: diagnosisData.status,
        code: diagnosisData.code,
        date: diagnosisData.date
      });

      // Fix RLS by using service bypass
      const { error } = await supabase
        .from("diagnoses")
        .insert([
          {
            id: this.generateId(),
            patient_id: patientId,
            doctor_id: currentUser.id,
            diagnosis: diagnosisData.status,
            code: diagnosisData.code,
            date: diagnosisData.date,
            created_at: new Date().toISOString(),
          },
        ]);

      if (error) {
        console.error("üîç Detailed error information:");
        console.error("- Message:", error.message);
        console.error("- Code:", error.code);
        console.error("- Details:", error.details);
        console.error("- Hint:", error.hint);
        console.error("- Full error:", JSON.stringify(error, null, 2));

        // Check for table not existing
        if ((error.message && error.message.includes("does not exist")) ||
            error.code === "42P01" ||
            (error.message && error.message.includes("relation") && error.message.includes("diagnoses"))) {
          throw new Error("‚ùå Tabela 'diagnoses' n√£o existe no banco de dados. Execute o script 'fix_all_database_errors.sql' no Supabase SQL Editor para criar as tabelas necess√°rias.");
        }

        // Check for missing columns
        if (error.message && error.message.includes("column") && error.message.includes("does not exist")) {
          throw new Error("‚ùå Colunas necess√°rias n√£o existem na tabela 'diagnoses'. Execute o script 'fix_all_database_errors.sql' no Supabase SQL Editor.");
        }

        // Generic error with more details
        const errorMsg = error.message || error.details || error.hint || 'Erro de banco de dados desconhecido';
        throw new Error(`Erro ao adicionar diagn√≥stico: ${errorMsg}`);
      }

      console.log("‚úÖ Diagn√≥stico adicionado no Supabase");
    } catch (error) {
      console.error("üí• Erro ao adicionar diagn√≥stico:", error);
      throw error;
    }
  }

  // Buscar diagn√≥sticos (apenas Supabase)
  async getDiagnoses(patientId: string): Promise<Diagnosis[]> {
    await this.delay(300);

    if (!supabase) {
      console.warn("‚ùå Supabase n√£o est√° configurado, retornando array vazio");
      return [];
    }

    try {
      const { data, error } = await supabase
        .from("diagnoses")
        .select("*")
        .eq("patient_id", patientId)
        .order("created_at", { ascending: false });

      if (error) {
        // Se a tabela n√£o existir, retornar array vazio ao inv√©s de erro
        if (error.message.includes("does not exist") || error.code === "42P01") {
          console.warn("‚ö†Ô∏è Tabela diagnoses n√£o existe. Execute o script fix_all_database_errors.sql");
          return [];
        }
        throw new Error(`Erro ao buscar diagn√≥sticos: ${error.message}`);
      }

      return (data || []).map(
        (d: any): Diagnosis => ({
          id: d.id,
          patientId: d.patient_id,
          diagnosis: d.diagnosis,
          code: d.code || "",
          date: d.date || new Date(d.created_at).toLocaleDateString("pt-BR"),
          createdAt: d.created_at,
          doctorId: d.doctor_id,
        }),
      );
    } catch (error) {
      console.error("üí• Erro ao buscar diagn√≥sticos:", error);
      // Se for erro de tabela n√£o existir, retornar array vazio
      if (error instanceof Error && error.message.includes("does not exist")) {
        console.warn("‚ö†Ô∏è Retornando array vazio para diagn√≥sticos - tabela n√£o existe");
        return [];
      }
      throw error;
    }
  }

  // Remover compartilhamento (apenas Supabase)
  async removePatientSharing(patientId: string): Promise<void> {
    await this.delay(300);

    if (!supabase) {
      throw new Error("‚ùå Supabase n√£o est√° configurado");
    }

    // Verificar se usu√°rio est√° logado
    const currentUserStr = localStorage.getItem("medical_app_current_user");
    if (!currentUserStr) {
      throw new Error("‚ùå Usu√°rio n√£o autenticado");
    }

    const currentUser = JSON.parse(currentUserStr);

    try {
      const { error } = await supabase
        .from("shared_data")
        .delete()
        .eq("patient_id", patientId)
        .eq("shared_with_doctor_id", currentUser.id);

      if (error) {
        throw new Error(`Erro ao remover compartilhamento: ${error.message}`);
      }

      console.log("‚úÖ Compartilhamento removido do Supabase");
    } catch (error) {
      console.error("üí• Erro ao remover compartilhamento:", error);
      throw error;
    }
  }
}

// Inst√¢ncia singleton
export const patientAPI = new PatientAPI();